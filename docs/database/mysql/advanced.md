### 引擎选择的因素考虑

- 事务:
  - 考虑事务的,请选择InnoDB
  - 不考虑事务,且只有查询和新增操作的,可以选择MyISAM
- 备份
  - 需要在线热备份的,请选择InnoDB
- 崩溃恢复 InnoDB相比MyISAM发生崩溃的概率小,恢复速度也快。
- 特有特性
  - 聚簇索引 InnoDB
  - 地理空间搜索 myisam
- 转换表的引擎
  - 最直接的方法是使用 ALTER TABLE tablename ENGINE = enginename, 但是会有一个问题,执行时间长,因为mysql会创建新的表,然后赋值数据,可能消耗掉系统所有的I/O能力
  - 通过导入导出,使用mysqldump工具
  - 创建与查询,创建表,然后使用INSERT INTO ... SELECT

### 性能剖析的理解

- 一般有两个步骤,使用性能剖析工具,譬如Percona Toolkit
  - 测量花费的时间
  - 统计排序,将重要的排在前面
- 一般讨论两种类型的性能剖析
  - 基于执行时间的,判断是什么任务执行时间最长
  - 基于等待时间的,判断任务在什么地方阻塞时间最长
  - 这是两个不同的分析角度
- 性能剖析还是有很多信息缺失,比如
  - 值得优化的查询,并不会在剖析中给出,但是有下面的原则
    - 占总响应时间比重比较小的查询,不值得优化,即使优化,收益也不会大于比重
    - 优化的成本大于收益,就要停止优化
  - 异常情况,执行频率低导致占比低,但是每次都很慢,严重影响用户体验的,也需要优化
  - 未知的情况,好的工具能提示一些丢失的时间,比如任务的总时间和实际测量时间存在差异,可能是没有测量到的任务
  - 被掩藏的细节,工具统计的是平均值,这样可能会丢失一些个别的细节

### 查询剖析的流程

- 服务器的负载剖析
  - 统计查询日志,通过设置long_query_time=0来设置mysql的慢查询日志,捕获所有的查询日志
    - 然后使用工具(pt-query-digest)来获取日志分析报告,其中的V/M列记录了方差均值比,也就是离差指数,这个数比较大的查询值得优化
      - 定位到需要优化的查询之后,则进行单条的剖析
        - 目前mysql的剖析查询对这一项分析的支持很少,只有有限的几种
        - show profile since5.1 需要 SET profiling=1 来打开
          - show profiles 显示当前会话中执行过的查询的情况,其中会有query id
          - show profile for 'query id' 显示该条查询的详细情况